<mt:setvarblock name="page_title"><__trans phrase="Database Configuration"></mt:setvarblock>

<mt:include name="include/chromeless_header.tmpl">

<form id="configure_form" method="post">
    <input type="hidden" name="__mode" value="" />
    <input type="hidden" name="step" value="configure" />
    <input type="hidden" name="set_static_uri_to" id="set_static_uri_to" value="<mt:var name="static_uri" escape="html">" />
    <input type="hidden" name="default_language" value="<mt:var name="default_language">" />
    <input type="hidden" name="config" value="<mt:var name="config" escape="html">" />

<mt:if name="connect_error">
    <mtapp:statusmsg
        id="connect_error"
        class="error">
        <mt:var name="error"><mt:if name="error_more">&nbsp;&nbsp;<a href="javascript:void(0)" onclick="return toggleMore()"><__trans phrase="Details"></a>.</mt:if>
    </mtapp:statusmsg>
    <div id="error_more" style="display:none"><mt:var name="error_more"></div>
<mt:else>
    <mt:if name="error">
    <mtapp:statusmsg
        id="error"
        class="error">
        <mt:var name="error">
    </mtapp:statusmsg>
    </mt:if>
</mt:if>

<mt:if name="success">
    <p class="intro"><span class="ready"><__trans phrase="Your database configuration is complete."></span> <__trans phrase="You may proceed to the next step."></p>
    <div id="success" class="actions-bar">
        <button
           name="continue"
           type="submit"
           onclick="go('next_step');"
           class="continue action primary-button"
           ><__trans phrase="Continue"></button>

        <button
           name="back"
           type="submit"
           onclick="needValidate = false; this.form.reset(); go('previous_step');"
           class="goback action"
           ><__trans phrase="Back"></button>
    </div>
<mt:else>
    <p class="intro"><__trans phrase="Please enter the parameters necessary for connecting to your database."></p>
</mt:if>

<mt:if name="success">
    <p id="show_settings"><a href="javascript:void(0)" onclick="showByID('db_settings'); hideByID('show_settings'); hideByID('success'); db_select(document.forms[0].dbtype); return false;"><__trans phrase="Show Current Settings"></a></p>
</mt:if>


    <fieldset id="db_settings" <mt:if name="success"> style="display: none;"</mt:if>>
        <mtapp:setting
            id="dbtype"
            label="<__trans phrase="Database Type">"
            label_class="top-label">
            <select id="dbtype" name="dbtype" onchange="db_select(this); hideByID('db_hint');">
            <mt:unless one_db>
                <option value=""><__trans phrase="Select One..."></option>
            </mt:unless>
            <mt:loop name="db_loop">
                <option value="<mt:var name="id">" <mt:if name="selected">selected="selected"</mt:if>><mt:var name="label"></option>
            </mt:loop>
            </select>
        </mtapp:setting>

<mt:unless name="success">
        <mt:setvarblock name="db_setup_url"><__trans phrase="http://www.movabletype.org/documentation/[_1]" params="installation/setting-up-your-database.html"></mt:setvarblock>
        <div id="db_hint">
            <p class="hint"><__trans phrase="Is your preferred database not listed? View the <a href="[_1]" target="_blank">Movable Type System Check</a> see if additional modules are necessary." params="mt-check.cgi"></p>
            <p class="hint"><__trans phrase="Once installed, <a href="javascript:void(0)" onclick="[_1]">click here to refresh this screen</a>." params="reTest();"></p>
            <p class="hint"><__trans phrase="Read more: <a href="[_1]" target="_blank">Setting Up Your Database</a>" params="<mt:var name="db_setup_url">"></p>
        </div>
</mt:unless>


        <div id="params" <mt:unless name="dbtype">style="display: none"</mt:unless>>

        <mt:loop name="field_loop">
            <mtapp:setting
                id="<mt:var name="id">"
                label="<mt:var name="label">"
                hint="<mt:var name="hint">"
                show_hint="<mt:var name="show_hint" default="0">">
                <input type="<mt:var name="type">" name="<mt:var name="id">" value="<mt:var name="default">" />
            </mtapp:setting>
        </mt:loop>

<mt:if name="advanced_loop">
            <p id="more"><a href="javascript:void(0)" onclick="showByID('db_port_socket'); hideByID('more'); return false;"><__trans phrase="Show Advanced Configuration Options"></a></p>
            <div id="db_port_socket" style="display: none;">
            <mt:loop name="advanced_loop">
                <mtapp:setting
                    id="<mt:var name="id">"
                    label="<mt:var name="label">">
                    <input type="<mt:var name="type">" name="<mt:var name="id">" value="<mt:var name="default">" />
                </mtapp:setting>
            </mt:loop>
            </div>
</mt:if>
        </div>

<mt:unless name="success">
        <div id="submit" class="actions-bar" <mt:unless name="dbtype">style="display: none"</mt:unless>>
            <button
                name="test"
                type="submit"
                value="1"
                onclick="go('test');"
                class="action primary-button"
                ><__trans phrase="Test Connection"></button>

            <button
                name="back"
                type="submit"
                onclick="needValidate = false; this.form.reset(); go('previous_step');"
                class="goback action"
                ><__trans phrase="Back"></button>
        </div>

        <div id="goback" class="actions-bar" <mt:if name="dbtype">style="display: none"</mt:if>>
            <button
                name="back"
                type="submit"
                onclick="needValidate = false; this.form.reset(); go('previous_step');"
                class="goback action"
                ><__trans phrase="Back"></button>
        </div>
</mt:unless>

<mt:if name="success">
        <div id="continue" class="actions-bar">
            <button
                name="continue"
                type="submit"
                onclick="go('next_step');"
                class="continue action primary-button"
                ><__trans phrase="Continue"></button>

            <button
                name="test"
                type="submit"
                value="1"
                onclick="go('test');"
                class="action primary-button"
                ><__trans phrase="Test Connection"></button>

            <button
                name="back"
                type="submit"
                onclick="needValidate = false; this.form.reset(); go('previous_step');"
                class="goback action"
                ><__trans phrase="Back"></button>
        </div>
</mt:if>
    </fieldset>

    <script type="text/javascript">
    /* <![CDATA[ */
        var db = new Array();
    <mt:loop name="db_loop">
<mt:if name="display">
        db['<mt:var name="id">'] = new Array(<mt:var name="display">);
</mt:if>
    </mt:loop>
    /* ]]> */
    </script>

<mt:loop name="field_loop">
<mt:var name="id"> : <mt:var name="element"> : <mt:var name="type"> : <mt:var name="label"> : <mt:var name="default"> : <mt:var name="hint"> : <mt:var name="show_hint"><br />
<mt:if name="type" eq="select">
  <mt:loop name="option_loop">
  <mt:var name="value"> : <mt:var name="label"><br />
  </mt:loop name>
</mt:if>
</mt:loop>

<mt:loop name="advanced_loop">
<mt:var name="id"> : <mt:var name="label"><br />
<mt:if name="type" eq="select">
  <mt:loop name="option_loop">
  <mt:var name="value"> : <mt:var name="label"><br />
  </mt:loop name>
</mt:if>
</mt:loop>


</form>
<script type="text/javascript">
/* <![CDATA[ */
var needValidate = true;

function validate (f) {
    if (needValidate) {
        var db = f.dbtype.options[f.dbtype.selectedIndex].value;
        if ((db == "sqlite") || (db == "sqlite2")) {
            if (!f.dbpath.value) {
                alert('<__trans phrase="You must set your Database Path." escape="js">');
                f.dbpath.focus();
                return false;
            }
        } else {    
            if ((!f.dbuser.value) && (db != "mssqlserver") && (db != "umssqlserver")) {
                alert('<__trans phrase="You must set your Username." escape="js">');
                f.dbuser.focus();
                return false;
            } else if ((!f.dbserver.value) && (db != "oracle")) {
                alert('<__trans phrase="You must set your Database Server." escape="js">');
                f.dbserver.focus();
                return false;
            }
        }
    }

    return true;
}
function go(mode) {
    var f = document.forms[0];
    f['__mode'].value = mode;
}

function db_select(sel) {
    var db = sel.options[sel.selectedIndex].value;
    if ((db == "mysql") || (db == "postgres") || (db == "oracle") || (db == "mssqlserver") || (db == "umssqlserver")) {
        showByID("login");
        hideByID("goback");
        showByID("server");
        hideByID("path");
        showByID("submit");
        showByID("params");
        showByID("use_setnames");
        if (db == "mssqlserver") {
            showByID("charset");
        } else {
            hideByID("charset");
        }
        if ((db == "mssqlserver") || (db == "umssqlserver")) {
            showByID("driver");
        } else {
            hideByID("driver");
        }
        if (db == "oracle") {
            hideByID("dbserver-field");
        } else {
            showByID("dbserver-field");
        }
        document.forms[0].dbname.focus();
    } else if ((db == "sqlite") || (db == "sqlite2")) {
        hideByID("login"); hideByID("server"); hideByID("goback"); hideByID("use_setnames");
        showByID("path");
        showByID("submit");
        showByID("params");
        document.forms[0].dbpath.focus();
    } else {
        showByID("goback");
        hideByID("submit");
        hideByID("params");
    }
    return true;
}

function toggleMore() {
    var more = getByID('error_more');
    if (more) {
        if (more.style.display == 'none')
            more.style.display = 'block';
        else
            more.style.display = 'none';
    }
}

function reTest() {
  needValidate = false; 
  go('retry'); 
  document.forms[0].submit();
}

<mt:unless name="success">
<mt:if name="one_db">
window.onload = function() {
    document.forms[0].dbtype.selectedIndex = 0;
    db_select(document.forms[0].dbtype);
}
</mt:if>
</mt:unless>
/* ]]> */
</script>
<mt:setvarblock name="jq_js_include" append="1">
    jQuery('#driver #odbcdriverversion-field').hide();
    jQuery('#odbcdrivername').change(function() {
        var selected = jQuery(this).val();
        if (selected == 'sqlservernativeclient') {
            jQuery('#driver #odbcdriverversion-field').show();
        } else {
            jQuery('#driver #odbcdriverversion-field').hide();
        }
    });
</mt:setvarblock>
<mt:include name="include/chromeless_footer.tmpl">
